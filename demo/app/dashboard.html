<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MITMproxy Traffic Inspection Demo</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #0f172a;
        height: 100vh;
        display: flex;
        flex-direction: column;
        color: #e2e8f0;
      }

      /* Header */
      header {
        background: #1e293b;
        padding: 0.5rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #334155;
      }
      h1 { color: #94a3b8; font-size: 0.9rem; font-weight: 500; }
      h1 span { color: #e2e8f0; font-weight: 600; }
      .header-status {
        display: flex;
        align-items: center;
        gap: 1rem;
        font-size: 0.75rem;
        color: #64748b;
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #64748b;
      }
      .status-dot.active { background: #22c55e; }

      /* Main Layout */
      .main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* App Pane (Left) */
      .app-pane {
        flex: 0 0 45%;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #334155;
      }
      .app-header {
        padding: 0.5rem 1rem;
        background: #1e293b;
        border-bottom: 1px solid #334155;
        font-size: 0.8rem;
        color: #94a3b8;
      }
      .app-iframe {
        flex: 1;
        border: none;
        background: #0f172a;
      }

      /* MITMproxy Pane (Right) */
      .mitm-pane {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #1e293b;
      }

      /* Tab Header with Controls */
      .mitm-header {
        display: flex;
        align-items: stretch;
        border-bottom: 1px solid #334155;
      }
      .mitm-tabs {
        display: flex;
        flex: 1;
      }
      .mitm-tab {
        padding: 0.625rem 1rem;
        background: transparent;
        border: none;
        color: #64748b;
        font-size: 0.8rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .mitm-tab:hover { color: #94a3b8; }
      .mitm-tab.active {
        color: #e2e8f0;
        border-bottom-color: #64748b;
      }
      .mitm-tab .indicator {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #475569;
      }
      .mitm-tab.capturing .indicator { background: #22c55e; }

      /* Service Toggle in Header */
      .service-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0 1rem;
        border-left: 1px solid #334155;
        font-size: 0.75rem;
        color: #64748b;
      }
      .toggle-switch {
        position: relative;
        width: 36px;
        height: 20px;
        cursor: pointer;
      }
      .toggle-switch input { opacity: 0; width: 0; height: 0; }
      .toggle-slider {
        position: absolute;
        inset: 0;
        background: #334155;
        border-radius: 20px;
        transition: all 0.2s;
      }
      .toggle-slider::before {
        content: "";
        position: absolute;
        width: 14px;
        height: 14px;
        left: 3px;
        bottom: 3px;
        background: #64748b;
        border-radius: 50%;
        transition: all 0.2s;
      }
      .toggle-switch input:checked + .toggle-slider { background: #475569; }
      .toggle-switch input:checked + .toggle-slider::before {
        transform: translateX(16px);
        background: #22c55e;
      }

      /* Tab Content */
      .mitm-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .tab-panel {
        display: none;
        flex: 1;
        flex-direction: column;
      }
      .tab-panel.active { display: flex; }

      /* Test Actions Bar */
      .actions-bar {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: #0f172a;
        border-bottom: 1px solid #334155;
      }
      .actions-label {
        font-size: 0.7rem;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .action-btn {
        padding: 0.375rem 0.75rem;
        background: #334155;
        border: none;
        border-radius: 0.25rem;
        color: #94a3b8;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.15s;
      }
      .action-btn:hover { background: #475569; color: #e2e8f0; }
      .action-btn code {
        color: #64748b;
        font-size: 0.65rem;
        margin-left: 0.25rem;
      }

      /* MITMproxy iframe */
      .mitm-iframe {
        flex: 1;
        border: none;
        background: #0f172a;
      }

      /* Challenges Panel (collapsible) */
      .challenges-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        background: #1e293b;
        border-top: 1px solid #334155;
        cursor: pointer;
        font-size: 0.75rem;
        color: #64748b;
      }
      .challenges-toggle:hover { background: #334155; }
      .challenges-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: #0f172a;
      }
      .challenges-content.open { max-height: 400px; overflow-y: auto; }
      .challenge {
        padding: 0.75rem;
        border-bottom: 1px solid #1e293b;
      }
      .challenge:last-child { border-bottom: none; }
      .challenge-title {
        font-size: 0.8rem;
        font-weight: 500;
        color: #e2e8f0;
        margin-bottom: 0.25rem;
      }
      .challenge-desc {
        font-size: 0.7rem;
        color: #64748b;
        margin-bottom: 0.5rem;
      }
      .challenge-btn {
        padding: 0.375rem 0.75rem;
        background: #334155;
        border: none;
        border-radius: 0.25rem;
        color: #94a3b8;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.15s;
      }
      .challenge-btn:hover { background: #475569; color: #e2e8f0; }
      .challenge-steps {
        font-size: 0.65rem;
        color: #64748b;
        margin-top: 0.5rem;
        padding-left: 1rem;
        line-height: 1.6;
      }
      .challenge-steps code {
        background: #1e293b;
        padding: 0.1rem 0.25rem;
        border-radius: 0.15rem;
        color: #94a3b8;
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: #334155;
        color: #e2e8f0;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        opacity: 0;
        transition: all 0.3s;
        z-index: 1000;
      }
      .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
      .toast.error { background: #7f1d1d; }

      /* Resize handle */
      .resize-handle {
        width: 4px;
        background: #334155;
        cursor: col-resize;
        transition: background 0.2s;
      }
      .resize-handle:hover { background: #475569; }
    </style>
  </head>
  <body>
    <header>
      <h1><span>MITMproxy</span> Traffic Inspection</h1>
      <div class="header-status">
        <span>caddy-api-client</span>
      </div>
    </header>

    <div class="main-container">
      <!-- App Pane -->
      <div class="app-pane" id="app-pane">
        <div class="app-header">Product Search Demo</div>
        <iframe class="app-iframe" id="app-iframe" src="http://localhost:9080/app/"></iframe>
      </div>

      <div class="resize-handle" id="resize-handle"></div>

      <!-- MITMproxy Pane -->
      <div class="mitm-pane">
        <div class="mitm-header">
          <div class="mitm-tabs">
            <button class="mitm-tab active" id="tab-es" data-target="es">
              <span class="indicator"></span>
              Elasticsearch
            </button>
            <button class="mitm-tab" id="tab-node" data-target="node">
              <span class="indicator"></span>
              Node API
            </button>
          </div>
          <div class="service-toggle" id="toggle-container">
            <span id="toggle-label">Intercept</span>
            <label class="toggle-switch">
              <input type="checkbox" id="toggle-intercept">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <div class="mitm-content">
          <!-- Elasticsearch Tab -->
          <div class="tab-panel active" id="panel-es">
            <div class="actions-bar">
              <span class="actions-label">Test</span>
              <button class="action-btn" id="test-search">Search Products <code>/es/_search</code></button>
              <button class="action-btn" id="test-bulk">Bulk Index <code>/es/_bulk</code></button>
              <button class="action-btn" id="test-query-bug">Bad Query <code>0 hits</code></button>
            </div>
            <iframe class="mitm-iframe" id="iframe-es" src="http://localhost:9080/mitmproxy/"></iframe>
          </div>

          <!-- Node API Tab -->
          <div class="tab-panel" id="panel-node">
            <div class="actions-bar">
              <span class="actions-label">Test</span>
              <button class="action-btn" id="test-echo">Echo <code>/node/echo</code></button>
              <button class="action-btn" id="test-random">Random <code>/node/random</code></button>
              <button class="action-btn" id="test-config">Config <code>/node/config</code></button>
            </div>
            <iframe class="mitm-iframe" id="iframe-node" src="http://localhost:9080/mitmproxy-node/"></iframe>
          </div>
        </div>

        <!-- Challenges (collapsible) -->
        <div class="challenges-toggle" id="challenges-toggle">
          <span>Debugging Challenges</span>
          <span id="challenges-arrow">▼</span>
        </div>
        <div class="challenges-content" id="challenges-content">
          <div class="challenge">
            <div class="challenge-title">Debug Bulk Indexing Failures</div>
            <div class="challenge-desc">Real symptom: _bulk returns 400 or partial failures</div>
            <button class="challenge-btn" id="btn-bulk-broken">Send Broken Bulk</button>
            <ol class="challenge-steps">
              <li>Find <code>/_bulk</code> in flow list</li>
              <li>Check request body for NDJSON issues</li>
              <li>Look for pretty-printed JSON, missing newlines</li>
              <li>Use <b>Replay</b> with fixed format</li>
            </ol>
          </div>
          <div class="challenge">
            <div class="challenge-title">Debug "0 Hits" Search Results</div>
            <div class="challenge-desc">Real symptom: Search returns empty unexpectedly</div>
            <button class="challenge-btn" id="btn-search-zero">Send Bad Query</button>
            <ol class="challenge-steps">
              <li>Find <code>/_search</code> request</li>
              <li>Check Query DSL: <code>category</code> needs exact case</li>
              <li>Wrong field: <code>product_name</code> → <code>name</code></li>
              <li><b>Edit</b> request and <b>Replay</b></li>
            </ol>
          </div>
          <div class="challenge">
            <div class="challenge-title">Analyze Burst Traffic</div>
            <div class="challenge-desc">Real symptom: 429 rejections, retry storms</div>
            <button class="challenge-btn" id="btn-rate-storm">Fire 10 Requests</button>
            <ol class="challenge-steps">
              <li>Watch timeline fill with burst</li>
              <li>Sort by timing to see pattern</li>
              <li>In production: spot 429s and retries</li>
            </ol>
          </div>
          <div class="challenge">
            <div class="challenge-title">Modify Response Data</div>
            <div class="challenge-desc">Change prices, inject products, fix errors</div>
            <ol class="challenge-steps">
              <li>Enable intercept in <b>Options</b> → <code>~s</code></li>
              <li>Search "keyboard" - response pauses</li>
              <li>Click flow → <b>Response</b> → <b>Edit</b></li>
              <li>Change <code>"price": 149.99</code> → <code>0.01</code></li>
              <li>Press <b>a</b> to resume</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      const API = "http://localhost:9080";

      // State
      let currentTab = "es";
      let state = { elasticsearch: false, nodeapi: false };

      // DOM
      const tabEs = document.getElementById("tab-es");
      const tabNode = document.getElementById("tab-node");
      const panelEs = document.getElementById("panel-es");
      const panelNode = document.getElementById("panel-node");
      const toggleIntercept = document.getElementById("toggle-intercept");
      const toggleLabel = document.getElementById("toggle-label");
      const toast = document.getElementById("toast");

      function showToast(msg, type = "success") {
        toast.textContent = msg;
        toast.className = `toast ${type} show`;
        setTimeout(() => toast.className = "toast", 3000);
      }

      // Tab switching
      function switchTab(tab) {
        currentTab = tab;
        tabEs.classList.toggle("active", tab === "es");
        tabNode.classList.toggle("active", tab === "node");
        panelEs.classList.toggle("active", tab === "es");
        panelNode.classList.toggle("active", tab === "node");

        // Update toggle to reflect current service state
        const serviceId = tab === "es" ? "elasticsearch" : "nodeapi";
        toggleIntercept.checked = state[serviceId];
        updateTabIndicators();
      }

      function updateTabIndicators() {
        tabEs.classList.toggle("capturing", state.elasticsearch);
        tabNode.classList.toggle("capturing", state.nodeapi);
      }

      // Toggle interception
      async function toggleService(enabled) {
        const serviceId = currentTab === "es" ? "elasticsearch" : "nodeapi";
        const action = enabled ? "enable" : "disable";

        try {
          const res = await fetch(`${API}/api/monitoring/${action}/${serviceId}`, { method: "POST" });
          const data = await res.json();
          state[serviceId] = enabled;
          updateTabIndicators();
          showToast(enabled ? `Intercepting ${serviceId}` : `Direct mode for ${serviceId}`);
        } catch (e) {
          showToast("Failed: " + e.message, "error");
          toggleIntercept.checked = !enabled;
        }
      }

      // Fetch initial status
      async function fetchStatus() {
        try {
          const res = await fetch(`${API}/api/monitoring/status`);
          const data = await res.json();
          state.elasticsearch = data.services?.elasticsearch?.enabled || false;
          state.nodeapi = data.services?.nodeapi?.enabled || false;
          toggleIntercept.checked = currentTab === "es" ? state.elasticsearch : state.nodeapi;
          updateTabIndicators();
        } catch (e) {
          console.error("Status fetch failed:", e);
        }
      }

      // Test requests
      async function testSearch() {
        showToast("Searching products...");
        try {
          const res = await fetch(`${API}/es/products/_search`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: { match: { name: "keyboard" } }, size: 5 })
          });
          const data = await res.json();
          const hits = data.hits?.total?.value ?? 0;
          showToast(`Found ${hits} products`);
        } catch (e) {
          showToast("Search failed: " + e.message, "error");
        }
      }

      async function testBulk() {
        showToast("Sending bulk request...");
        try {
          const res = await fetch(`${API}/api/challenge/bulk-broken`, { method: "POST" });
          const data = await res.json();
          if (data.esResponse?.errors) {
            showToast("Bulk had errors - check MITMproxy", "error");
          } else {
            showToast("Bulk complete - inspect the format");
          }
        } catch (e) {
          showToast("Bulk failed: " + e.message, "error");
        }
      }

      async function testQueryBug() {
        showToast("Sending broken query...");
        try {
          const res = await fetch(`${API}/api/challenge/search-zero-hits`, { method: "POST" });
          const data = await res.json();
          const hits = data.esResponse?.hits?.total?.value ?? 0;
          showToast(hits === 0 ? "0 hits! Check Query DSL" : `Got ${hits} hits`, hits === 0 ? "error" : "success");
        } catch (e) {
          showToast("Query failed: " + e.message, "error");
        }
      }

      async function testEcho() {
        showToast("Sending echo...");
        try {
          const res = await fetch(`${API}/node/echo`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ test: "data", time: Date.now() })
          });
          const data = await res.json();
          showToast("Echo received");
        } catch (e) {
          showToast("Echo failed: " + e.message, "error");
        }
      }

      async function testRandom() {
        showToast("Fetching random...");
        try {
          const res = await fetch(`${API}/node/random`);
          const data = await res.json();
          showToast(`Random: ${data.random?.toFixed(4)}`);
        } catch (e) {
          showToast("Random failed: " + e.message, "error");
        }
      }

      async function testConfig() {
        showToast("Fetching config...");
        try {
          const res = await fetch(`${API}/node/config`);
          const data = await res.json();
          showToast(`Theme: ${data.theme}, App: ${data.appName}`);
        } catch (e) {
          showToast("Config failed: " + e.message, "error");
        }
      }

      async function testRateStorm() {
        if (!state.elasticsearch) {
          showToast("Enable ES intercept first", "error");
          return;
        }
        showToast("Firing 10 requests...");
        try {
          const res = await fetch(`${API}/api/challenge/rate-limit-storm`, { method: "POST" });
          const data = await res.json();
          showToast(`Burst done in ${data.totalTime}ms`);
        } catch (e) {
          showToast("Burst failed: " + e.message, "error");
        }
      }

      // Event listeners
      tabEs.addEventListener("click", () => switchTab("es"));
      tabNode.addEventListener("click", () => switchTab("node"));
      toggleIntercept.addEventListener("change", e => toggleService(e.target.checked));

      document.getElementById("test-search").addEventListener("click", testSearch);
      document.getElementById("test-bulk").addEventListener("click", testBulk);
      document.getElementById("test-query-bug").addEventListener("click", testQueryBug);
      document.getElementById("test-echo").addEventListener("click", testEcho);
      document.getElementById("test-random").addEventListener("click", testRandom);
      document.getElementById("test-config").addEventListener("click", testConfig);

      document.getElementById("btn-bulk-broken")?.addEventListener("click", testBulk);
      document.getElementById("btn-search-zero")?.addEventListener("click", testQueryBug);
      document.getElementById("btn-rate-storm")?.addEventListener("click", testRateStorm);

      // Challenges toggle
      document.getElementById("challenges-toggle").addEventListener("click", () => {
        const content = document.getElementById("challenges-content");
        const arrow = document.getElementById("challenges-arrow");
        content.classList.toggle("open");
        arrow.textContent = content.classList.contains("open") ? "▲" : "▼";
      });

      // Resize handle
      const resizeHandle = document.getElementById("resize-handle");
      const appPane = document.getElementById("app-pane");
      let isResizing = false;

      resizeHandle.addEventListener("mousedown", () => { isResizing = true; });
      document.addEventListener("mousemove", e => {
        if (!isResizing) return;
        const containerWidth = document.querySelector(".main-container").offsetWidth;
        const newWidth = (e.clientX / containerWidth) * 100;
        if (newWidth > 20 && newWidth < 80) {
          appPane.style.flex = `0 0 ${newWidth}%`;
        }
      });
      document.addEventListener("mouseup", () => { isResizing = false; });

      // Init
      fetchStatus();
    </script>
  </body>
</html>

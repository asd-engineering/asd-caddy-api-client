name: CI

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run ESLint
        run: bun run lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run TypeScript compiler
        run: bun run typecheck

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run unit tests
        run: bun run test

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/unit/coverage-final.json
          flags: unit
          name: unit-tests
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      caddy:
        image: caddy:2.9-alpine
        ports:
          - 2019:2019
          - 8080:80
          - 8443:443
        env:
          CADDY_ADMIN: 0.0.0.0:2019
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:2019/config/ || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s

      mitmproxy:
        image: mitmproxy/mitmproxy:10.4.2
        ports:
          - 8081:8081
          - 8082:8080
        options: >-
          --health-cmd "curl -f http://localhost:8081/ || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --health-start-period 10s
        env:
          MITMPROXY_OPTS: >-
            mitmweb
            --mode reverse:http://backend-test:5681
            --web-host 0.0.0.0
            --web-port 8081
            --listen-host 0.0.0.0
            --listen-port 8080
            --no-web-open-browser
            --set keep_host_header=true

      backend-test:
        image: mendhak/http-https-echo:latest
        ports:
          - 5681:5681
        env:
          HTTP_PORT: 5681
          LOG_WITHOUT_NEWLINE: true
        options: >-
          --health-cmd "wget --quiet --tries=1 --spider http://localhost:5681/ || exit 1"
          --health-interval 5s
          --health-timeout 2s
          --health-retries 5
          --health-start-period 5s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Wait for services to be ready
        run: |
          echo "Waiting for Caddy..."
          timeout 30 bash -c 'until curl -f http://localhost:2019/config/; do sleep 2; done'
          echo "Waiting for MITMproxy..."
          timeout 30 bash -c 'until curl -f http://localhost:8081/; do sleep 2; done'
          echo "Waiting for Backend..."
          timeout 30 bash -c 'until curl -f http://localhost:5681/; do sleep 2; done'
          echo "All services ready!"

      - name: Initialize Caddy configuration
        run: |
          curl -X PATCH http://localhost:2019/config/apps/http/servers \
            -H "Content-Type: application/json" \
            -d '{"https_server":{"listen":[":80"],"routes":[],"automatic_https":{"disable":true}}}'

      - name: Run integration tests
        run: bun run test:integration
        env:
          INTEGRATION_TEST: true
          CADDY_ADMIN_URL: http://localhost:2019
          CADDY_HTTP_URL: http://localhost:8080

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/integration/coverage-final.json
          flags: integration
          name: integration-tests
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build package
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

services:
  mock-oauth:
    image: ghcr.io/navikt/mock-oauth2-server:latest
    container_name: mock-oauth2-server
    ports:
      - "9000:9000"
    environment:
      SERVER_PORT: "9000"
      JSON_CONFIG: |
        {
          "interactiveLogin": true,
          "httpServer": "NettyWrapper",
          "tokenCallbacks": [
            {
              "issuerId": "default",
              "tokenExpiry": 3600,
              "requestMappings": [
                {
                  "requestParam": "scope",
                  "match": "openid profile email",
                  "claims": {
                    "sub": "regular-user",
                    "email": "user@example.com",
                    "name": "Regular User",
                    "preferred_username": "regularuser",
                    "roles": ["user"],
                    "groups": ["users"]
                  }
                },
                {
                  "requestParam": "scope",
                  "match": "openid admin",
                  "claims": {
                    "sub": "admin-user",
                    "email": "admin@example.com",
                    "name": "Admin User",
                    "preferred_username": "adminuser",
                    "roles": ["admin", "user"],
                    "groups": ["users", "admins"]
                  }
                },
                {
                  "requestParam": "scope",
                  "match": "openid",
                  "claims": {
                    "sub": "test-user",
                    "email": "test@example.com",
                    "name": "Test User",
                    "roles": ["user"]
                  }
                }
              ]
            },
            {
              "issuerId": "short-lived",
              "tokenExpiry": 5,
              "requestMappings": [
                {
                  "requestParam": "scope",
                  "match": "*",
                  "claims": {
                    "sub": "short-lived-user",
                    "email": "shortlived@example.com"
                  }
                }
              ]
            },
            {
              "issuerId": "no-roles",
              "tokenExpiry": 3600,
              "requestMappings": [
                {
                  "requestParam": "scope",
                  "match": "*",
                  "claims": {
                    "sub": "no-roles-user",
                    "email": "noroles@example.com"
                  }
                }
              ]
            }
          ]
        }
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "-q",
          "--spider",
          "http://localhost:9000/default/.well-known/openid-configuration",
        ]
      interval: 5s
      timeout: 3s
      retries: 10

  caddy:
    image: caddy:2-alpine
    container_name: caddy-oauth-test
    ports:
      - "8080:80"
      - "8443:443"
      - "2019:2019"
    volumes:
      - ./Caddyfile.oauth:/etc/caddy/Caddyfile:ro
    depends_on:
      mock-oauth:
        condition: service_healthy
    environment:
      OAUTH_CLIENT_ID: test-client
      OAUTH_CLIENT_SECRET: test-secret
